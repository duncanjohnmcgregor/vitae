name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Fast validation jobs that don't need dependencies
  validate-structure:
    name: üèóÔ∏è Structure & Config
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate file structure
      run: |
        echo "üîç Validating project structure..."
        
        # Check critical files exist
        missing_files=()
        required_files=("firebase.json" ".firebaserc" "firestore.rules" "deploy.ps1")
        
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing_files+=("$file")
          else
            echo "‚úÖ $file found"
          fi
        done
        
        if [[ ${#missing_files[@]} -gt 0 ]]; then
          echo "‚ùå Missing required files: ${missing_files[*]}"
          exit 1
        fi
        
        # Check src directory structure
        if [[ -d "src" ]]; then
          echo "‚úÖ src directory found"
          html_files=("index.html" "pricing.html" "how-it-works.html" "start-your-story.html")
          for file in "${html_files[@]}"; do
            if [[ -f "src/$file" ]]; then
              echo "‚úÖ src/$file found"
            else
              echo "‚ö†Ô∏è src/$file missing"
            fi
          done
          
          # Check admin panel files
          if [[ -f "src/admin.html" ]]; then
            echo "‚úÖ src/admin.html found"
          else
            echo "‚ö†Ô∏è src/admin.html missing (admin panel not configured)"
          fi
        else
          echo "‚ùå src directory not found!"
          exit 1
        fi
        
        # Check for production firestore rules
        if [[ -f "firestore.rules.production" ]]; then
          echo "‚úÖ firestore.rules.production found"
        else
          echo "‚ö†Ô∏è firestore.rules.production missing (needed for secure deployment)"
        fi

    - name: Validate JSON configurations
      run: |
        echo "üîç Validating JSON configurations..."
        
        # Validate firebase.json
        if jq empty firebase.json 2>/dev/null; then
          echo "‚úÖ firebase.json is valid JSON"
          
          # Check required sections
          if jq -e '.hosting' firebase.json >/dev/null; then
            echo "‚úÖ Firebase Hosting configuration found"
          else
            echo "‚ö†Ô∏è No hosting configuration in firebase.json"
          fi
          
          if jq -e '.functions' firebase.json >/dev/null; then
            echo "‚úÖ Firebase Functions configuration found"
          else
            echo "‚ö†Ô∏è No functions configuration in firebase.json"
          fi
          
          if jq -e '.firestore' firebase.json >/dev/null; then
            echo "‚úÖ Firestore configuration found"
          else
            echo "‚ö†Ô∏è No firestore configuration in firebase.json"
          fi
          
          # Check for admin route configuration
          if jq -e '.hosting.rewrites[] | select(.source == "/admin")' firebase.json >/dev/null; then
            echo "‚úÖ Admin route configuration found"
          else
            echo "‚ö†Ô∏è No admin route configured in firebase.json"
          fi
        else
          echo "‚ùå firebase.json is invalid JSON"
          exit 1
        fi
        
        # Validate .firebaserc
        if jq empty .firebaserc 2>/dev/null; then
          echo "‚úÖ .firebaserc is valid JSON"
        else
          echo "‚ùå .firebaserc is invalid JSON"
          exit 1
        fi



  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 4
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Scan for secrets
      run: |
        echo "üîç Scanning for potential secrets..."
        
        # Check for common secret patterns
        secret_patterns=(
          "password\s*=\s*[\"'][^\"']+[\"']"
          "api[_-]?key\s*=\s*[\"'][^\"']+[\"']"
          "secret\s*=\s*[\"'][^\"']+[\"']"
          "token\s*=\s*[\"'][^\"']+[\"']"
          "sk_live_"
          "pk_live_"
          "AKIA[0-9A-Z]{16}"
        )
        
        found_issues=false
        for pattern in "${secret_patterns[@]}"; do
          if grep -r -E "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.log" 2>/dev/null; then
            echo "‚ö†Ô∏è Potential secret found matching pattern: $pattern"
            found_issues=true
          fi
        done
        
        if [[ "$found_issues" == "false" ]]; then
          echo "‚úÖ No obvious secrets found"
        fi

    - name: Check Firestore rules security
      run: |
        echo "üîç Checking Firestore rules security..."
        
        # Check if using insecure development rules
        if grep -q "allow read, write: if true" firestore.rules; then
          echo "‚ö†Ô∏è WARNING: firestore.rules contains insecure development rules!"
          echo "  Development rules should not be used in production"
          
          # Check if production rules exist
          if [[ -f "firestore.rules.production" ]]; then
            echo "‚úÖ Production rules file exists (firestore.rules.production)"
            echo "  Ensure deployment uses production rules"
          else
            echo "‚ùå No production rules file found!"
            echo "  Create firestore.rules.production with secure rules"
          fi
        else
          echo "‚úÖ firestore.rules doesn't contain obvious insecure patterns"
        fi

    - name: Check admin authentication
      run: |
        echo "üîç Checking admin authentication configuration..."
        
        # Check admin.html for hardcoded credentials
        if [[ -f "src/admin.html" ]]; then
          if grep -q "password.*=.*['\"]admin['\"]" src/admin.html || \
             grep -q "password.*=.*['\"]password['\"]" src/admin.html || \
             grep -q "credentials.*hardcoded" src/admin.html; then
            echo "‚ùå Found potential hardcoded credentials in admin.html!"
            echo "  Use Firebase Authentication instead"
            exit 1
          else
            echo "‚úÖ No obvious hardcoded credentials in admin.html"
          fi
          
          # Check for Firebase Auth usage
          if grep -q "firebase.auth()" src/admin.html; then
            echo "‚úÖ Admin panel appears to use Firebase Authentication"
          else
            echo "‚ö†Ô∏è Admin panel might not be using Firebase Authentication"
          fi
        fi

    - name: Check for vulnerable dependencies
      run: |
        echo "üîç Checking for .env files and other sensitive files..."
        
        # Check for .env files
        if find . -name "*.env" -not -path "./node_modules/*" | grep -q .; then
          echo "‚ö†Ô∏è Found .env files:"
          find . -name "*.env" -not -path "./node_modules/*"
          echo "Ensure these are in .gitignore and don't contain real credentials"
        else
          echo "‚úÖ No .env files found in repository"
        fi

  # Jobs that need dependencies
  setup-cache:
    name: üì¶ Setup Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 8
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate cache key
      id: cache-key
      run: |
        key="deps-${{ runner.os }}-${{ env.NODE_VERSION }}-$(sha256sum functions/package-lock.json package-lock.json | sha256sum | cut -d' ' -f1)"
        echo "key=$key" >> $GITHUB_OUTPUT
        echo "Generated cache key: $key"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Cache dependencies
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          functions/node_modules
          ~/.npm
        key: ${{ steps.cache-key.outputs.key }}
        restore-keys: |
          deps-${{ runner.os }}-${{ env.NODE_VERSION }}-

    - name: Install dependencies
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        echo "üì¶ Installing dependencies..."
        
        # Install root dependencies if package.json exists
        if [[ -f "package.json" ]]; then
          echo "Installing root dependencies..."
          npm ci --prefer-offline --no-audit --no-fund
          echo "‚úÖ Root dependencies installed"
        fi
        
        # Install functions dependencies
        if [[ -f "functions/package.json" ]]; then
          echo "Installing functions dependencies..."
          cd functions
          npm ci --prefer-offline --no-audit --no-fund
          cd ..
          echo "‚úÖ Functions dependencies installed"
        fi

  lint-frontend:
    name: üé® Frontend Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Lint HTML files
      run: |
        echo "üîç Linting HTML files..."
        
        html_files=$(find src -name "*.html" 2>/dev/null || true)
        if [[ -n "$html_files" ]]; then
          for file in $html_files; do
            echo "Checking $file..."
            # Basic HTML validation
            if grep -q "<!DOCTYPE" "$file" && grep -q "<html" "$file" && grep -q "</html>" "$file"; then
              echo "‚úÖ $file has basic HTML structure"
            else
              echo "‚ö†Ô∏è $file missing basic HTML structure"
            fi
          done
        else
          echo "‚ö†Ô∏è No HTML files found in src directory"
        fi

    - name: Lint CSS files
      run: |
        echo "üîç Linting CSS files..."
        
        css_files=$(find src -name "*.css" 2>/dev/null || true)
        if [[ -n "$css_files" ]]; then
          for file in $css_files; do
            echo "Checking $file..."
            # Basic CSS syntax check
            if [[ -s "$file" ]]; then
              echo "‚úÖ $file exists and is not empty"
            else
              echo "‚ö†Ô∏è $file is empty"
            fi
          done
        else
          echo "‚ö†Ô∏è No CSS files found in src directory"
        fi

    - name: Lint JavaScript files
      run: |
        echo "üîç Linting JavaScript files..."
        
        js_files=$(find src -name "*.js" 2>/dev/null || true)
        if [[ -n "$js_files" ]]; then
          for file in $js_files; do
            echo "Checking $file..."
            # Check for potential security issues
            if grep -q "eval(" "$file"; then
              echo "‚ö†Ô∏è Found eval() usage in $file - potential security risk"
            fi
            if grep -q "innerHTML.*+" "$file"; then
              echo "‚ö†Ô∏è Found dynamic innerHTML in $file - potential XSS risk"
            fi
            echo "‚úÖ $file basic checks passed"
          done
        else
          echo "‚ö†Ô∏è No JavaScript files found in src directory"
        fi

    - name: Lint admin panel
      run: |
        echo "üîç Linting admin panel..."
        
        if [[ -f "src/admin.html" ]]; then
          echo "Checking admin.html..."
          
          # Check for inline scripts
          if grep -q "<script[^>]*>[^<]" src/admin.html; then
            echo "‚úÖ Admin panel contains inline scripts (expected for authentication)"
          fi
          
          # Check for Firebase imports
          if grep -q "firebase-app.js" src/admin.html && grep -q "firebase-auth.js" src/admin.html; then
            echo "‚úÖ Admin panel imports Firebase libraries"
          else
            echo "‚ö†Ô∏è Admin panel missing Firebase library imports"
          fi
          
          # Check for security headers
          if grep -q "Content-Security-Policy" src/admin.html; then
            echo "‚úÖ Admin panel has CSP headers"
          else
            echo "‚ö†Ô∏è Consider adding Content-Security-Policy headers"
          fi
        else
          echo "‚ö†Ô∏è No admin panel found (src/admin.html)"
        fi

  test-backend:
    name: üß™ Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: setup-cache
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Restore dependencies
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          functions/node_modules
          ~/.npm
        key: ${{ needs.setup-cache.outputs.cache-key }}
        restore-keys: |
          deps-${{ runner.os }}-${{ env.NODE_VERSION }}-

    - name: Run ESLint
      run: |
        echo "üîç Running ESLint on functions..."
        if [[ -f "functions/package.json" ]]; then
          cd functions
          if npm run lint --if-present; then
            echo "‚úÖ ESLint passed"
          else
            echo "‚ö†Ô∏è ESLint found issues"
            exit 1
          fi
          cd ..
        else
          echo "‚ö†Ô∏è No functions package.json found"
        fi

    - name: Run tests
      run: |
        echo "üß™ Running backend tests..."
        if [[ -f "functions/package.json" ]]; then
          cd functions
          if npm test --if-present; then
            echo "‚úÖ Tests passed"
          else
            echo "‚ö†Ô∏è Tests failed or no test script found"
          fi
          cd ..
        else
          echo "‚ö†Ô∏è No functions package.json found"
        fi
      continue-on-error: true

  validate-firebase:
    name: üî• Firebase Validation
    runs-on: ubuntu-latest
    timeout-minutes: 6
    needs: setup-cache
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install Firebase CLI
      run: |
        npm install -g firebase-tools

    - name: Validate Firebase configuration
      run: |
        echo "üîç Validating Firebase configuration..."
        
        # Validate firebase.json schema
        if firebase --help >/dev/null 2>&1; then
          echo "‚úÖ Firebase CLI installed successfully"
        else
          echo "‚ùå Firebase CLI installation failed"
          exit 1
        fi
        
        # Check if firebase.json is valid
        if [[ -f "firebase.json" ]]; then
          echo "‚úÖ firebase.json found"
        else
          echo "‚ùå firebase.json not found"
          exit 1
        fi

    - name: Validate Firestore rules
      run: |
        echo "üîç Validating Firestore rules..."
        if [[ -f "firestore.rules" ]]; then
          echo "‚úÖ firestore.rules found"
          # Basic syntax check for Firestore rules
          if grep -q "rules_version" firestore.rules; then
            echo "‚úÖ firestore.rules has rules_version"
          else
            echo "‚ö†Ô∏è firestore.rules missing rules_version"
          fi
        else
          echo "‚ö†Ô∏è firestore.rules not found"
        fi

  # Summary job that waits for all validations
  validation-summary:
    name: üìã Validation Summary
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [validate-structure, security-scan, lint-frontend, test-backend, validate-firebase]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "# üìã PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pull Request:** #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üîç Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| üèóÔ∏è Structure & Config | ${{ needs.validate-structure.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| üîí Security Scan | ${{ needs.security-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| üé® Frontend Lint | ${{ needs.lint-frontend.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| üß™ Backend Tests | ${{ needs.test-backend.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| üî• Firebase Validation | ${{ needs.validate-firebase.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if all validations passed
        if [[ "${{ needs.validate-structure.result }}" == "success" ]] && 
           [[ "${{ needs.security-scan.result }}" == "success" ]] && 
           [[ "${{ needs.lint-frontend.result }}" == "success" ]] && 
           [[ "${{ needs.test-backend.result }}" == "success" ]] && 
           [[ "${{ needs.validate-firebase.result }}" == "success" ]]; then
          echo "## üéâ All Validations Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR meets all quality standards and is ready for review." >> $GITHUB_STEP_SUMMARY
          echo "Once approved and merged, it will automatically deploy to production." >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "üéâ ALL VALIDATIONS PASSED!"
          echo "This PR meets quality standards and is ready for review."
        else
          echo "## ‚ùå Some Validations Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed checks above and fix them before merging." >> $GITHUB_STEP_SUMMARY
          echo "All validations must pass before the PR can be merged into main." >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "‚ùå SOME VALIDATIONS FAILED!"
          echo "Please review the issues above and fix them before merging."
          exit 1
        fi 